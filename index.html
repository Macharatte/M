<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Premium Calculator v140</title>
    <style>
        /* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        * { 
            -webkit-tap-highlight-color: transparent; 
            box-sizing: border-box; 
            touch-action: pan-x pan-y;
        }
        
        button, .mode-btn, .side-bar, .history-clear {
            user-select: none;
            -webkit-user-select: none;
        }

        body { 
            background-color: #0d0d0d; 
            color: #e0e0e0; 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            height: 100dvh; 
            overflow: hidden; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            padding-bottom: env(safe-area-inset-bottom);
        }

        header { background: #1a1a1a; padding: 1vh 0; text-align: center; border-bottom: 2px solid #d4af37; flex: 0 0 auto; }
        h1 { margin: 0; font-size: clamp(1rem, 4vw, 1.2rem); color: #d4af37; letter-spacing: 2px; }

        #summary-overlay { 
            display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 85%; max-width: 500px; background: rgba(34, 34, 34, 0.98); color: #ffd700; padding: 20px; 
            font-size: 0.9rem; text-align: center; border: 2px solid #d4af37; border-radius: 10px; 
            line-height: 1.6; font-weight: bold; z-index: 1000; box-shadow: 0 0 30px rgba(0,0,0,0.9);
        }

        #display-container { 
            flex: 0 0 14vh; 
            display: flex; 
            align-items: center; 
            padding: 0 20px; 
            background: #000; 
            border-bottom: 1px solid #222; 
            overflow: hidden;
        }
        #display { 
            width: 100%; 
            font-size: clamp(2rem, 8vh, 4rem); 
            text-align: right; 
            border: none; 
            background: transparent; 
            color: #fff; 
            outline: none; 
            overflow-x: auto; 
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            padding: 10px 0;
            min-height: 1.2em;
            scrollbar-width: thin;
            caret-color: #d4af37;
            user-select: text;
            -webkit-user-select: text;
        }
        #display::-webkit-scrollbar { height: 4px; }
        #display::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }

        .mode-selector { 
            display: flex; overflow-x: auto; background: #1a1a1a; flex: 0 0 auto; 
            scrollbar-width: none; -ms-overflow-style: none; border-bottom: 1px solid #333;
        }
        .mode-btn { 
            flex: 1 0 70px; height: 45px; font-size: 0.8rem; border: none; cursor: pointer; 
            background: #222; color: #888; font-weight: bold; white-space: nowrap; transition: 0.2s;
        }
        .mode-btn.active { background: #d4af37 !important; color: #000 !important; }

        .key-area { flex: 1; padding: 4px; background: #111; overflow-y: auto; display: flex; flex-direction: column; }
        .keypad, .ext-panel { display: none; grid-template-columns: repeat(4, 1fr); gap: 4px; width: 100%; height: 100%; }
        #panel-basic { display: grid; }

        button { 
            border: none; border-radius: 6px; font-size: clamp(1.2rem, 3.5vh, 2rem); 
            cursor: pointer; background: #262626; color: #fff; display: flex; 
            align-items: center; justify-content: center; min-height: 50px;
        }
        .op { color: #d4af37; background: #2a2a2a; }
        .equal { background: #d4af37; color: #000; font-weight: bold; }
        .ac { color: #ff4d4d; }
        .c-btn { color: #ffa500; }
        
        .split-btn { display: grid; grid-template-columns: 1fr 1fr; gap: 2px; padding: 0; background: transparent; }
        .split-btn button { border-radius: 4px; font-size: 1.2rem; height: 100%; }

        .premium-ui { grid-column: span 4; background: #1a1a1a; padding: 12px; border-radius: 10px; border: 1px solid #333; display: flex; flex-direction: column; gap: 8px; }
        .premium-ui label { font-size: 0.75rem; color: #d4af37; font-weight: bold; }
        .premium-ui input, .premium-ui select { width: 100%; height: 44px; background: #2a2a2a; border: 1px solid #444; color: #fff; border-radius: 6px; font-size: 1rem; padding: 0 10px; }
        .result-box { background: #000; border: 2px solid #d4af37; min-height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 6px; margin-top: 5px; }
        .res-main { font-size: 1.1rem; font-weight: bold; color: #fff; text-align: center; }
        .calc-action-btn { background: #d4af37; color: #000; font-weight: bold; height: 50px; border-radius: 6px; font-size: 1.1rem; }

        .bottom-area { 
            flex: 0 0 auto; 
            height: 140px; 
            display: grid; 
            grid-template-columns: 70px 1fr 70px; 
            gap: 8px; 
            padding: 8px 8px calc(8px + env(safe-area-inset-bottom)); 
            background: #000; 
            border-top: 1px solid #d4af37; 
            z-index: 50;
        }
        .side-bar { background: #1a1a1a; border: 1px solid #444; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; cursor: pointer; color: #d4af37; position: relative; height: 100%; }
        #history-box { border: 1px solid #333; border-radius: 10px; background: #080808; display: flex; overflow: hidden; position: relative; height: 100%; }
        #history-list { flex: 1; overflow-y: auto; padding: 10px; font-size: 0.95rem; color: #ccc; line-height: 1.4; height: 100%; }
        .history-clear { 
            width: 45px; height: 100%; font-size: 0.75rem; font-weight: bold;
            background: #222; color: #ff4d4d; border: none; border-right: 1px solid #333;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            writing-mode: vertical-rl; text-orientation: upright; letter-spacing: 2px;
        }

        #lang-select { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; font-size: 1.5rem; }

        .hidden { display: none !important; }
        input[type="range"] { width: 100%; margin: 10px 0; -webkit-appearance: none; background: #333; height: 6px; border-radius: 3px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 22px; height: 22px; background: #d4af37; border-radius: 50%; }
    </style>
</head>
<body>

<header><h1 id="main-title">PREMIUM CALCULATOR</h1></header>

<div id="summary-overlay" onclick="toggleSummary()">
    å½“é›»å“ã¯åŸºæœ¬æ©Ÿèƒ½ã€æ¥é ­èªã€å€¤æ•°ã€ç§‘å­¦è¨ˆç®—ã€ãƒ¬ãƒ¼ãƒˆã€ç¨é‡‘è¨ˆç®—ã€è©¦ç®—ã€è¨€èªã€å±¥æ­´ãŒã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™<br><br>
    â€»å¸Œã«ä¸å…·åˆãŒèµ·ã“ã‚‹å ´åˆãŒã”ã–ã„ã¾ã™ã®ã§äºˆã‚ã”äº†æ‰¿ãã ã•ã„<br><br>
    <small>(ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹)</small>
</div>

<div id="display-container"><div id="display" contenteditable="true" inputmode="none">0</div></div>

<div class="mode-selector">
    <button class="mode-btn active" id="m-basic" onclick="showPanel('basic', this)">åŸºæœ¬</button>
    <button class="mode-btn" id="m-unit" onclick="showPanel('unit', this)">æ¥é ­èª</button>
    <button class="mode-btn" id="m-stats" onclick="showPanel('stats', this)">å€¤æ•°</button>
    <button class="mode-btn" id="m-sci" onclick="showPanel('sci', this)">ç§‘å­¦</button>
    <button class="mode-btn" id="m-rate" onclick="showPanel('rate', this)">ãƒ¬ãƒ¼ãƒˆ</button>
    <button class="mode-btn" id="m-tax" onclick="showPanel('tax', this)">ç¨é‡‘</button>
    <button class="mode-btn" id="m-tc" onclick="showPanel('tc', this)">è©¦ç®—</button>
</div>

<div class="key-area">
    <div id="panel-basic" class="keypad">
        <button class="ac" onclick="clearAll()">AC</button>
        <button class="c-btn" onclick="backspace()">C</button>
        <div class="split-btn">
            <button class="op" onclick="add('(')">(</button>
            <button class="op" onclick="add(')')">)</button>
        </div>
        <button class="op" onclick="add('Ã·')">Ã·</button>
        <button onclick="add('7')">7</button><button onclick="add('8')">8</button><button onclick="add('9')">9</button><button class="op" onclick="add('Ã—')">Ã—</button>
        <button onclick="add('4')">4</button><button onclick="add('5')">5</button><button onclick="add('6')">6</button><button class="op" onclick="add('-')">-</button>
        <button onclick="add('1')">1</button><button onclick="add('2')">2</button><button onclick="add('3')">3</button><button class="op" onclick="add('+')">+</button>
        <button onclick="add('0')">0</button><button onclick="add('.')">.</button><button class="op" onclick="add(',')">,</button><button class="equal" onclick="calculate()">=</button>
    </div>

    <div id="panel-unit" class="ext-panel" style="grid-template-columns: repeat(6, 1fr);">
        <script>
            const prefixes_list = ['Q','R','Y','Z','E','P','T','G','M','k','h','da','d','c','m','Î¼','n','p','f','a','z','y','r','q'];
            prefixes_list.forEach(u => document.write(`<button style="color:#d4af37; font-size:clamp(1.4rem, 4vh, 2rem); font-weight:bold;" onclick="add('${u}')">${u}</button>`));
        </script>
    </div>

    <div id="panel-stats" class="ext-panel">
        <button id="s-avg" onclick="add('å¹³å‡å€¤(')">å¹³å‡</button><button id="s-mid" onclick="add('ä¸­å¤®å€¤(')">ä¸­å¤®</button>
        <button id="s-mod" onclick="add('æœ€é »å€¤(')">æœ€é »</button><button id="s-mul" onclick="add('^')">ä¹—æ•°</button>
        <button id="s-max" onclick="add('æœ€å¤§å€¤(')">æœ€å¤§</button><button id="s-min" onclick="add('æœ€å°å€¤(')">æœ€å°</button>
        <button class="op" onclick="add(',')">,</button><button class="op" onclick="add(')')">)</button>
    </div>

    <div id="panel-sci" class="ext-panel">
        <button onclick="add('sin(')">sin</button><button onclick="add('cos(')">cos</button><button onclick="add('tan(')">tan</button><button onclick="add('âˆš(')">âˆš</button>
        <button class="op" onclick="add('^')">^</button><button onclick="add('i')">i</button><button onclick="add('Â°')">Â°</button><button onclick="add('Ï€')">Ï€</button>
        <button onclick="add('e')">e</button><button onclick="add('log(')">log</button><button onclick="add('â»')">(-)</button><button class="op" onclick="add(')')">)</button>
    </div>

    <div id="panel-rate" class="ext-panel"><div class="premium-ui"><label id="l-rate-amt">é‡‘é¡</label><input type="text" id="rate-amount" value="1"><div style="display:flex; gap:5px;"><div style="flex:1"><label id="l-rate-from">å…ƒ</label><select id="rate-from"></select></div><div style="flex:1"><label id="l-rate-to">å…ˆ</label><select id="rate-to"></select></div></div><button id="btn-calc-rate" class="calc-action-btn" onclick="fetchRate()">ãƒ¬ãƒ¼ãƒˆè¨ˆç®—å®Ÿè¡Œ</button><div id="rate-result" class="result-box">---</div></div></div>

    <div id="panel-tax" class="ext-panel"><div class="premium-ui"><label id="l-tax-amt">èª²ç¨å¯¾è±¡é¡</label><input type="text" id="tax-amount" value="50M"><div id="tax-people-box" class="hidden"><label id="l-tax-people">æ³•å®šç›¸ç¶šäººæ•°: 1äºº</label><input type="range" id="tax-people-slider" min="1" max="10" value="1" oninput="updateTaxPeople(this.value)"></div><label id="l-tax-type">ç¨ç›®é¸æŠ</label><select id="tax-type" onchange="toggleTaxUI()"></select><button id="btn-calc-tax" class="calc-action-btn" onclick="calcTaxAdvanced()">ç¨é‡‘è¨ˆç®—å®Ÿè¡Œ</button><div id="tax-result" class="result-box">---</div></div></div>

    <div id="panel-tc" class="ext-panel"><div class="premium-ui"><label id="l-tc-amt">å¯¾è±¡é‡‘é¡</label><input type="text" id="tc-amount" value="1k"><div id="tc-day-box" class="hidden"><label id="l-tc-day">1æ—¥ã‚ãŸã‚Šã®ä½¿ç”¨é‡/æ™‚é–“</label><div style="position:relative;"><input type="text" id="tc-day-val" value="1"><span id="unit-suffix" style="position:absolute; right:10px; top:12px; color:#888; pointer-events:none;"></span></div></div><div id="tc-salary-options"><label id="holiday-label">å¹´é–“ä¼‘æ—¥: 120æ—¥</label><input type="range" id="tc-holiday-slider" min="0" max="365" value="120" oninput="updateHolidayLabel(this.value)"><label id="l-tc-mode">çµ¦æ–™åŒºåˆ†</label><select id="tc-salary-mode"></select></div><label id="l-tc-type">é …ç›®</label><select id="tc-type" onchange="toggleTCUI()"></select><button id="btn-calc-tc" class="calc-action-btn" onclick="calcTC()">è©¦ç®—å®Ÿè¡Œ</button><div id="tax-result-tc" class="result-box"><span id="tc-res-text">---</span></div></div></div>
</div>

<div class="bottom-area">
    <div class="side-bar">ğŸŒ<select id="lang-select" onchange="changeLang(this.value)">
        <option value="ja">æ—¥æœ¬èª / Japanese</option>
        <option value="en">English</option>
        <option value="zh">ä¸­æ–‡ / Chinese</option>
        <option value="es">EspaÃ±ol / Spanish</option>
    </select></div>
    <div id="history-box">
        <button class="history-clear" onclick="clearHistory()">CLEAR</button>
        <div id="history-list"></div>
    </div>
    <div class="side-bar" onclick="toggleSummary()">i</div>
</div>

<script>
    const disp = document.getElementById('display');
    let isCalculated = false, currentLang = 'ja';
    let isBracketOpen = false;

    const pMap = {'Q':'1000000000000000000000000000000','R':'1000000000000000000000000000','Y':'1000000000000000000000000','Z':'1000000000000000000000','E':'1000000000000000000','P':'1000000000000000','T':'1000000000000','G':'1000000000','M':'1000000','k':'1000','h':'100','da':'10','d':'0.1','c':'0.01','m':'0.001','Î¼':'0.000001','n':'0.000000001','p':'0.000000000001','f':'0.000000000000001','a':'0.000000000000000001','z':'0.000000000000000000001','y':'0.000000000000000000000001','r':'0.000000000000000000000000001','q':'0.000000000000000000000000000001'};

    const tokens = ["sin(", "cos(", "tan(", "log(", "âˆš(", "å¹³å‡å€¤(", "ä¸­å¤®å€¤(", "æœ€é »å€¤(", "æœ€å¤§å€¤(", "æœ€å°å€¤("];
    const ops = ['+', '-', 'Ã—', 'Ã·', '^', ','];
    const limitTokens = ['.', 'Â°', 'i', 'e', 'Ï€'];

    function setCursor(pos) {
        disp.focus();
        const sel = window.getSelection();
        if (disp.childNodes.length > 0) {
            const range = document.createRange();
            const node = disp.childNodes[0];
            const targetPos = Math.min(Math.max(0, pos), node.length);
            range.setStart(node, targetPos);
            range.collapse(true);
            sel.removeAllRanges();
            sel.addRange(range);
        }
    }

    function getSafePos() {
        const sel = window.getSelection();
        if (sel.rangeCount > 0) {
            const range = sel.getRangeAt(0);
            if (range.startContainer === disp || range.startContainer.parentNode === disp) {
                return range.startOffset;
            }
        }
        return disp.innerText.length;
    }

    function insertAtCursor(text) {
        let content = disp.innerText;
        let pos = getSafePos();
        let newPosAdjustment = text.length;

        if (content === "0" && pos === 1 && text !== '.' && !ops.includes(text) && text !== 'â»') {
            content = ""; pos = 0;
        }

        // --- é–¢æ•°ã®åˆ‡ã‚Šæ›¿ãˆãƒ­ã‚¸ãƒƒã‚¯ ---
        // æ‹¬å¼§ãŒé–‹ã„ã¦ã„ã‚‹çŠ¶æ…‹ã§ã€åˆ¥ã®é–¢æ•°ãƒœã‚¿ãƒ³ï¼ˆsin(ç­‰ï¼‰ãŒæŠ¼ã•ã‚ŒãŸå ´åˆ
        if (isBracketOpen && text.includes('(')) {
            // ç¾åœ¨ã®ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ä»˜è¿‘ã«ã‚ã‚‹æœªå®Œæˆã®é–¢æ•°ã‚’ç‰¹å®šã—ã¦å‰Šé™¤
            for (let t of tokens) {
                let idx = content.lastIndexOf(t, pos - 1);
                if (idx !== -1 && !content.substring(idx).includes(')')) {
                    // ãã®é–¢æ•°ã‚’å‰Šé™¤ã—ã¦ç½®ãæ›ãˆã‚‹
                    const before = content.substring(0, idx);
                    const after = content.substring(pos);
                    content = before + after;
                    pos = idx;
                    break;
                }
            }
        } else if (isBracketOpen) {
            // é€šå¸¸ã®ãƒ­ãƒƒã‚¯ï¼šæ‹¬å¼§å†…ã§ã®åˆ¶é™
            const allowedInBracket = /^[0-9.,â»]$/;
            if (!allowedInBracket.test(text) && text !== ')') return;
        }

        // æ¼”ç®—å­ãŠã‚ˆã³ç‰¹å®šè¨˜å·ã®é€£ç¶šå…¥åŠ›ãƒã‚§ãƒƒã‚¯
        let prevChar = content[pos-1];
        if (ops.includes(text) || limitTokens.includes(text)) {
            if (ops.includes(prevChar) || limitTokens.includes(prevChar)) {
                content = content.substring(0, pos-1) + content.substring(pos);
                pos = pos - 1;
            }
        }

        const finalStr = content.substring(0, pos) + text + content.substring(pos);

        // ãƒ­ãƒƒã‚¯ã®æ›´æ–°
        if (text.includes('(')) isBracketOpen = true;
        if (text === ')') isBracketOpen = false;

        window.getSelection().removeAllRanges();
        disp.textContent = ""; 
        
        requestAnimationFrame(() => {
            disp.textContent = finalStr;
            requestAnimationFrame(() => {
                setCursor(pos + newPosAdjustment);
            });
        });
    }

    function add(val) {
        if (isCalculated) {
            if (!ops.includes(val) && !limitTokens.includes(val) && val !== 'â»' && !val.includes('(')) disp.innerText = "0";
            isCalculated = false;
        }
        insertAtCursor(val);
        if (disp.scrollWidth > disp.clientWidth) disp.scrollLeft = disp.scrollWidth;
    }

    function backspace() {
        let content = disp.innerText;
        let pos = getSafePos();
        if (pos === 0 || content === "0") return;

        let start = pos - 1, end = pos;
        for (let t of tokens) {
            let idx = -1;
            while ((idx = content.indexOf(t, idx + 1)) !== -1) {
                if (pos > idx && pos <= idx + t.length) {
                    start = idx; end = idx + t.length; break;
                }
            }
        }

        const newText = content.substring(0, start) + content.substring(end);
        // ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã‚’å†è©•ä¾¡ï¼ˆé–‹ã„ã¦ã„ã‚‹æ‹¬å¼§ãŒã‚ã‚‹ã‹ï¼‰
        let openCount = (newText.match(/\(/g) || []).length;
        let closeCount = (newText.match(/\)/g) || []).length;
        isBracketOpen = openCount > closeCount;

        window.getSelection().removeAllRanges();
        disp.textContent = "";

        requestAnimationFrame(() => {
            disp.textContent = newText || "0";
            requestAnimationFrame(() => {
                setCursor(start);
            });
        });
    }

    function clearAll() { 
        window.getSelection().removeAllRanges();
        disp.textContent = "0"; 
        isCalculated = false;
        isBracketOpen = false;
    }
    
    function clearHistory() { document.getElementById('history-list').innerHTML = ""; }

    const processStr = (s) => {
        let res = s.replace(/Ã—/g,'*').replace(/Ã·/g,'/');
        const pKeys = Object.keys(pMap).sort((a,b) => b.length - a.length);
        pKeys.forEach(p => {
            const escapedP = p.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const reg = new RegExp('(\\d+(\\.\\d+)?|(?<=[^a-zA-Z\\d.]|^))' + escapedP + '(?![a-zA-Z\\d])', 'g');
            res = res.replace(reg, (match, p1) => { if (p === 'e' && match.includes('1e')) return match; const base = (p1 && !isNaN(p1)) ? p1 : "1"; return '(' + base + '*' + pMap[p] + ')'; });
        });
        return res;
    };

    const getNums = (str) => { return str.split(',').map(part => { try { return parseFloat(eval(processStr(part.trim()))); } catch { return NaN; } }).filter(n => !isNaN(n)); };
    const _avg = (g) => { const n = getNums(g); return n.length ? n.reduce((a,b)=>a+b)/n.length : 0; };
    const _mid = (g) => { const n = getNums(g).sort((a,b)=>a-b); const l=n.length, m=Math.floor(l/2); return l ? (l%2?n[m]:(n[m-1]+n[m])/2) : 0; };
    const _mod = (g) => { const n = getNums(g); if(!n.length) return 0; const f = {}; n.forEach(x => f[x] = (f[x]||0)+1); const max = Math.max(...Object.values(f)); const res = Object.keys(f).filter(k => f[k] === max); return res.join('&'); };
    const _max = (g) => { const n = getNums(g); return n.length ? Math.max(...n) : 0; };
    const _min = (g) => { const n = getNums(g); return n.length ? Math.min(...n) : 0; };

    function calculate() {
        if (isBracketOpen) return;
        try {
            let originalInput = disp.innerText;
            if (originalInput === "0") return;
            let parts = originalInput.split(/,(?![^\(]*\))/);
            let results = parts.map(part => {
                let s = part.trim();
                s = s.replace(/å¹³å‡å€¤\((.*?)\)/g, (m, g) => _avg(g)).replace(/ä¸­å¤®å€¤\((.*?)\)/g, (m, g) => _mid(g))
                     .replace(/æœ€é »å€¤\((.*?)\)/g, (m, g) => _mod(g)).replace(/æœ€å¤§å€¤\((.*?)\)/g, (m, g) => _max(g)).replace(/æœ€å°å€¤\((.*?)\)/g, (m, g) => _min(g));
                s = processStr(s);
                s = s.replace(/Ï€/g,Math.PI).replace(/e/g,Math.E).replace(/â»/g,'-').replace(/\^/g,'**')
                     .replace(/âˆš\((.*?)\)/g, 'Math.sqrt($1)').replace(/sin\((.*?)\)/g, 'Math.sin($1*Math.PI/180)')
                     .replace(/cos\((.*?)\)/g, 'Math.cos($1*Math.PI/180)').replace(/tan\((.*?)\)/g, 'Math.tan($1*Math.PI/180)')
                     .replace(/log\((.*?)\)/g, 'Math.log10($1)');
                let res = eval(s);
                if (typeof res === 'number') {
                    if (Math.abs(res) >= 1e21 || (Math.abs(res) < 1e-7 && res !== 0)) return res.toExponential().replace(/\+/, '');
                    return parseFloat(Number(res).toPrecision(15));
                }
                return res;
            });
            let finalOutput = results.join(', ');
            const log = document.getElementById('history-list');
            const item = document.createElement('div');
            item.style.borderBottom = "1px solid #222"; item.style.padding = "5px 0";
            item.innerHTML = `<small>${new Date().toLocaleTimeString()}</small><br>${originalInput} = <b style="color:#d4af37">${finalOutput}</b>`;
            log.prepend(item);
            disp.innerText = finalOutput;
            isCalculated = true;
            isBracketOpen = false;
        } catch { disp.innerText = "Error"; isCalculated = true; }
    }

    function toggleSummary() { const o = document.getElementById('summary-overlay'); o.style.display = (o.style.display === 'block') ? 'none' : 'block'; }
    function showPanel(id, btn) { document.querySelectorAll('.keypad, .ext-panel').forEach(p => p.style.display = 'none'); document.getElementById('panel-' + id).style.display = 'grid'; document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
    function parsePrefix(val) {
        if (!val) return 0;
        let s = String(val).trim();
        const pKeys = Object.keys(pMap).sort((a,b) => b.length - a.length);
        for (let p of pKeys) { if (s.endsWith(p)) { let base = s.slice(0, -p.length); return (base === "" ? 1 : parseFloat(base)) * Number(pMap[p]); } }
        return parseFloat(s);
    }
    async function fetchRate() {
        const resBox = document.getElementById('rate-result'); resBox.innerText = '...';
        try {
            const r = await fetch('https://open.er-api.com/v6/latest/USD');
            const d = await r.json();
            const amt = parsePrefix(document.getElementById('rate-amount').value);
            const from = document.getElementById('rate-from').value, to = document.getElementById('rate-to').value;
            const val = (amt / d.rates[from]) * d.rates[to];
            resBox.innerHTML = `<span class="res-main">${amt.toLocaleString()}${from} = ${val.toLocaleString()}${to}</span>`;
        } catch { resBox.innerText = 'Error'; }
    }
    function calcTaxAdvanced() {
        const a = parsePrefix(document.getElementById('tax-amount').value);
        let tax = 0, type = document.getElementById('tax-type').value;
        if(type==='income') {
            if(a <= 1950000) tax = a * 0.05;
            else if(a <= 3300000) tax = a * 0.1 - 97500;
            else if(a <= 6950000) tax = a * 0.2 - 427500;
            else if(a <= 8999000) tax = a * 0.23 - 636000;
            else if(a <= 17999000) tax = a * 0.33 - 1536000;
            else if(a <= 39999000) tax = a * 0.4 - 2796000;
            else tax = a * 0.45 - 4796000;
        } else if(type==='residence') tax = a * 0.1;
        else if(type==='consump10') tax = a * 0.1;
        else if(type==='consump8') tax = a * 0.08;
        else if(type==='gift') {
            let base = a - 1100000;
            if(base <= 0) tax = 0;
            else if(base <= 2000000) tax = base * 0.1;
            else if(base <= 3000000) tax = base * 0.15 - 100000;
            else if(base <= 4000000) tax = base * 0.2 - 250000;
            else if(base <= 6000000) tax = base * 0.3 - 650000;
            else if(base <= 10000000) tax = base * 0.4 - 1250000;
            else if(base <= 15000000) tax = base * 0.45 - 1750000;
            else tax = base * 0.5 - 2500000;
        } else if(type==='inheritance') {
            const p = parseInt(document.getElementById('tax-people-slider').value);
            const kiso = 30000000 + (6000000 * p);
            let taxableTotal = a - kiso;
            if(taxableTotal <= 0) tax = 0;
            else {
                let share = taxableTotal / p; let shareTax = 0;
                if(share <= 10000000) shareTax = share * 0.1;
                else if(share <= 30000000) shareTax = share * 0.15 - 500000;
                else if(share <= 50000000) shareTax = share * 0.2 - 2000000;
                else if(share <= 100000000) shareTax = share * 0.3 - 7000000;
                else if(share <= 200000000) shareTax = share * 0.4 - 17000000;
                else if(share <= 300000000) shareTax = share * 0.45 - 27000000;
                else shareTax = share * 0.5 - 42000000;
                tax = shareTax * p;
            }
        } else if(type==='corp') tax = a * 0.232;
        document.getElementById('tax-result').innerHTML = `<span class="res-main">Â¥${Math.max(0, Math.floor(tax)).toLocaleString()}</span>`;
    }
    function calcTC() {
        const type = document.getElementById('tc-type').value;
        const dv = parsePrefix(document.getElementById('tc-day-val').value) || 0;
        const resEl = document.getElementById('tc-res-text');
        if (type === 'sal') {
            const amt = parsePrefix(document.getElementById('tc-amount').value) || 0;
            const h = parseInt(document.getElementById('tc-holiday-slider').value), mode = document.getElementById('tc-salary-mode').value, workDays = 365 - h;
            if (mode === 'rev') resEl.innerHTML = `Day: Â¥${Math.floor(amt/workDays).toLocaleString()}<br>Hour: Â¥${Math.floor(amt/workDays/8).toLocaleString()}`;
            else resEl.innerHTML = `Annual: Â¥${Math.floor(mode==='day' ? amt*workDays : amt*8*workDays).toLocaleString()}`;
        } else if (type === 'gas') {
            const mc = 1500 + ((dv * 30) * 150); resEl.innerHTML = `Month: Â¥${Math.floor(mc).toLocaleString()}<br>Year: Â¥${Math.floor(mc * 12).toLocaleString()}`;
        } else if (type === 'water') {
            const mu = dv * 30; let j = 0;
            if(mu > 5) { if(mu <= 10) j = (mu - 5) * 22; else if(mu <= 20) j = (5 * 22) + (mu - 10) * 128; else if(mu <= 30) j = (5 * 22) + (10 * 128) + (mu - 20) * 163; else j = (5 * 22) + (10 * 128) + (10 * 163) + (mu - 30) * 213; }
            const mc = (1000 + j) * 1.1; resEl.innerHTML = `Month: Â¥${Math.floor(mc).toLocaleString()}<br>Year: Â¥${Math.floor(mc * 12).toLocaleString()}`;
        } else if (type === 'elec') {
            const mc = (dv * 31) * 30; resEl.innerHTML = `Month: Â¥${Math.floor(mc).toLocaleString()}<br>Year: Â¥${Math.floor(mc * 12).toLocaleString()}`;
        } else { resEl.innerHTML = `Month: Â¥${(dv*30).toLocaleString()}<br>Year: Â¥${(dv*365).toLocaleString()}`; }
    }
    const langData = {
        ja: {title:"PREMIUM CALCULATOR", m1:"åŸºæœ¬", m2:"æ¥é ­èª", m3:"å€¤æ•°", m4:"ç§‘å­¦", m5:"ãƒ¬ãƒ¼ãƒˆ", m6:"ç¨é‡‘", m7:"è©¦ç®—", hol:"å¹´é–“ä¼‘æ—¥: ", s1:"å¹³å‡", s2:"ä¸­å¤®", s3:"æœ€é »", s4:"ä¹—æ•°", s5:"æœ€å¤§", s6:"æœ€å°", tax_opt:["æ‰€å¾—ç¨","ä½æ°‘ç¨","æ¶ˆè²»ç¨10%","æ¶ˆè²»ç¨8%","æ³•äººç¨","è´ˆä¸ç¨","ç›¸ç¶šç¨"], sal_opt:["æ—¥å½“â†’å¹´å","æ™‚çµ¦â†’å¹´å","å¹´åâ†’æ—¥å½“/æ™‚çµ¦"], tc_opt:["çµ¦æ–™","é£Ÿè²»","æ°´é“","ã‚¬ã‚¹","é›»æ°—"]},
        en: {title:"PRM CALCULATOR", m1:"Basic", m2:"Prefix", m3:"Stats", m4:"Sci", m5:"Rate", m6:"Tax", m7:"Sim", hol:"Holidays: ", s1:"Avg", s2:"Mid", s3:"Mode", s4:"Mul", s5:"Max", s6:"Min", tax_opt:["Income","Residence","VAT10","VAT8","Corp","Gift","Inherit"], sal_opt:["Daily to Annual","Hourly to Annual","Annual to Day/Hour"], tc_opt:["Salary","Food","Water","Gas","Elec"]},
        zh: {title:"é«˜çº§è®¡ç®—å™¨", m1:"åŸºç¡€", m2:"è¯ç¶´", m3:"ç»Ÿè®¡", m4:"ç§‘å­¦", m5:"æ±‡ç‡", m6:"ç¨åŠ¡", m7:"æ¨¡æ‹Ÿ", hol:"å¹´å‡: ", s1:"å¹³å‡", s2:"ä¸­ä½", s3:"ä¼—æ•°", s4:"ä¹˜æ•°", s5:"æœ€å¤§å€¼", s6:"æœ€å°å€¼", tax_opt:["æ‰€å¾—ç¨","å±…ä½ç¨","å¢å€¼ç¨10%","å¢å€¼ç¨8%","ä¼ä¸šç¨","èµ ä¸ç¨","é—äº§ç¨"], sal_opt:["æ—¥è–ªâ†’å¹´è–ª","æ—¶è–ªâ†’å¹´è–ª","å¹´è–ªâ†’æ—¥/æ—¶"], tc_opt:["å·¥èµ„","ä¼™é£Ÿ","æ°´è´¹","ç‡ƒæ°”","ç”µè´¹"]},
        es: {title:"CALCULADORA PRM", m1:"BÃ¡sico", m2:"Prefijo", m3:"Estad.", m4:"Cien.", m5:"Tasa", m6:"Impues.", m7:"Sim.", hol:"Vacaciones: ", s1:"Prom.", s2:"Med.", s3:"Moda", s4:"Mult.", s5:"MÃ¡x.", s6:"MÃ­n.", tax_opt:["Renta","Residencia","IVA10","IVA8","Corp.","DonaciÃ³n","SucesiÃ³n"], sal_opt:["Diarioâ†’Anual","Horaâ†’Anual","Anualâ†’DÃ­a/Hour"], tc_opt:["Salario","Comida","Agua","Gas","Elect."]}
    };
    function changeLang(l) {
        currentLang = l; const d = langData[l] || langData.en;
        document.getElementById('main-title').innerText = d.title;
        ['m-basic','m-unit','m-stats','m-sci','m-rate','m-tax','m-tc'].forEach((id,i)=>document.getElementById(id).innerText=d['m'+(i+1)]);
        ['s-avg','s-mid','s-mod','s-mul','s-max','s-min'].forEach((id,i)=> { if(document.getElementById(id)) document.getElementById(id).innerText=d['s'+(i+1)]; });
        updateSelect('tax-type', d.tax_opt, ['income','residence','consump10','consump8','corp','gift','inheritance']);
        updateSelect('tc-salary-mode', d.sal_opt, ['day','hour','rev']);
        updateSelect('tc-type', d.tc_opt, ['sal', 'food', 'water', 'gas', 'elec']);
        toggleTCUI();
    }
    function updateSelect(id, texts, vals) { const s = document.getElementById(id); s.innerHTML = ""; texts.forEach((t, i) => s.add(new Option(t, vals[i]))); }
    function updateTaxPeople(v) { document.getElementById('l-tax-people').innerText = `æ³•å®šç›¸ç¶šäººæ•°: ${v}äºº`; }
    function updateHolidayLabel(v) { document.getElementById('holiday-label').innerText = (langData[currentLang]?.hol || "Holidays: ") + v; }
    function toggleTaxUI() { document.getElementById('tax-people-box').className = (document.getElementById('tax-type').value === 'inheritance') ? '' : 'hidden'; }
    function toggleTCUI() {
        const type = document.getElementById('tc-type').value; const isSal = type === 'sal';
        const labelAmt = document.getElementById('l-tc-amt'); const inputAmt = document.getElementById('tc-amount'); const unitSuffix = document.getElementById('unit-suffix');
        document.getElementById('tc-day-box').className = isSal ? 'hidden' : ''; document.getElementById('tc-salary-options').className = isSal ? '' : 'hidden';
        if (type === 'water' || type === 'gas') unitSuffix.innerText = 'm3'; else if (type === 'elec') unitSuffix.innerText = 'kWh'; else unitSuffix.innerText = '';
        if (type === 'gas') { labelAmt.innerText = "..."; inputAmt.value = "1500 + 150/m3"; inputAmt.readOnly = true; }
        else if (type === 'water') { labelAmt.innerText = "..."; inputAmt.value = "TOKYO"; inputAmt.readOnly = true; }
        else if (type === 'elec') { labelAmt.innerText = "..."; inputAmt.value = "1kWh=31"; inputAmt.readOnly = true; }
        else if (type === 'food') { labelAmt.innerText = "..."; inputAmt.value = "Daily Target"; inputAmt.readOnly = true; }
        else if (isSal) { labelAmt.innerText = "Amount"; inputAmt.value = "1k"; inputAmt.readOnly = false; }
        else { labelAmt.innerText = "Amount"; inputAmt.value = "0"; inputAmt.readOnly = false; }
    }

    window.onload = () => {
        const cur = ["JPY","USD","EUR","GBP","CNY","KRW"]; const f = document.getElementById('rate-from'), t = document.getElementById('rate-to');
        cur.forEach(c => { f.add(new Option(c, c)); t.add(new Option(c, c)); }); f.value = "USD"; t.value = "JPY"; changeLang('ja');
        disp.addEventListener('keydown', (e) => { if (!['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(e.key)) e.preventDefault(); });
        disp.addEventListener('focus', () => { if(disp.innerText === "0") requestAnimationFrame(() => setCursor(1)); });
    };
</script>
</body>
</html>
